<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chapter Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- MarkerCluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .toolbar {
      position: absolute;
      z-index: 999;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 360px;
    }
    .toolbar input {
      width: 340px;
      max-width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .toolbar .meta {
      margin-top: 6px;
      font-size: 12px;
      color: #444;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <input id="search" placeholder="Search chapter / city / state / country..." />
    <div class="meta" id="meta">Loading chaptersâ€¦</div>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    const map = L.map('map', { worldCopyJump: true }).setView([20, 0], 2);

    // OpenStreetMap tiles (free)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const cluster = L.markerClusterGroup();
    map.addLayer(cluster);

    const metaEl = document.getElementById('meta');
    const searchEl = document.getElementById('search');

    let allMarkers = [];
    let allData = [];

    function locationLabel(row) {
      const parts = [row.city, row.stateRegion, row.country].filter(Boolean);
      return parts.join(', ');
    }

    function addMarkers(rows) {
      cluster.clearLayers();
      allMarkers = [];

      const bounds = [];

      for (const row of rows) {
        if (typeof row.lat !== 'number' || typeof row.lng !== 'number') continue;

        const label = locationLabel(row);

        const m = L.marker([row.lat, row.lng]);

        // Hover tooltip: City / State / Country
        m.bindTooltip(label, { direction: 'top', sticky: true });

        // Click popup (optional): include chapter name
        const popupHtml = `
          <div style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;">
            <div style="font-weight: 700; margin-bottom: 4px;">${escapeHtml(row.chapterName)}</div>
            <div>${escapeHtml(label)}</div>
          </div>
        `;
        m.bindPopup(popupHtml);

        cluster.addLayer(m);
        allMarkers.push({ marker: m, row });

        bounds.push([row.lat, row.lng]);
      }

      metaEl.textContent = `Showing ${rows.length} chapters (${bounds.length} mapped)`;

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function applySearch() {
      const q = searchEl.value.trim().toLowerCase();
      if (!q) {
        addMarkers(allData);
        return;
      }

      const filtered = allData.filter(r => {
        const hay = [
          r.chapterName,
          r.city,
          r.stateRegion,
          r.country
        ].filter(Boolean).join(' ').toLowerCase();
        return hay.includes(q);
      });

      addMarkers(filtered);
    }

    async function load() {
      // chapters.json is generated in /data. When serving, we'll map it to /chapters.json
      const res = await fetch('/chapters.json');
      const rows = await res.json();

      allData = rows.map(r => ({
        id: r.id,
        chapterName: r.chapterName,
        city: r.city,
        stateRegion: r.stateRegion,
        country: r.country,
        lat: r.lat,
        lng: r.lng
      }));

      addMarkers(allData);
    }

    searchEl.addEventListener('input', () => applySearch());

    load().catch(err => {
      metaEl.textContent = 'Failed to load chapters.json (did you run the geocode step?)';
      console.error(err);
    });
  </script>
</body>
</html>
