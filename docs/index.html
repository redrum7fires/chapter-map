<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chapter Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- MarkerCluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }

    .toolbar {
      position: absolute;
      z-index: 999;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.96);
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.18);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 380px;
    }

    .toolbar input {
      width: 360px;
      max-width: 100%;
      padding: 8px 10px;
      border: 1px solid #cfcfcf;
      border-radius: 8px;
      outline: none;
    }

    .toolbar .meta {
      margin-top: 6px;
      font-size: 12px;
      color: #444;
    }

    .popup-wrap {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-width: 220px;
      max-width: 320px;
    }
    .popup-title {
      font-weight: 800;
      margin: 0 0 4px 0;
      font-size: 14px;
    }
    .popup-sub {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: #333;
    }
    .popup-row {
      font-size: 13px;
      margin: 4px 0;
      line-height: 1.25em;
    }
    .popup-row strong {
      font-weight: 700;
    }
    .phone {
      text-decoration: none;
    }
  </style>
</head>

<body>
  <div class="toolbar">
    <input id="search" placeholder="Search chapter / city / state / country / officers..." />
    <div class="meta" id="meta">Loading chapters…</div>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
   const map = L.map('map', {
  worldCopyJump: true,
  zoomControl: false
}).setView([20, 0], 2);

// Add zoom controls to top-right
L.control.zoom({ position: 'topright' }).addTo(map);


    // OpenStreetMap tiles (free)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const cluster = L.markerClusterGroup();
    map.addLayer(cluster);

    const metaEl = document.getElementById('meta');
    const searchEl = document.getElementById('search');

    let allData = [];

    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function locationLabel(row) {
      const parts = [row.city, row.stateRegion, row.country].filter(Boolean);
      return parts.join(', ');
    }

    function phoneToTelHref(phone) {
      if (!phone) return '';
      const cleaned = String(phone).trim().replace(/[^\d+]/g, '');
      return cleaned ? `tel:${cleaned}` : '';
    }

    function buildPopupHtml(row) {
      const label = locationLabel(row);

      const presPhoneHref = phoneToTelHref(row.presidentCell);
      const vpPhoneHref = phoneToTelHref(row.vicePresidentCell);

      return `
        <div class="popup-wrap">
          <div class="popup-title">${escapeHtml(row.chapterName || 'Chapter')}</div>
          <div class="popup-sub">${escapeHtml(label)}</div>

          ${row.presidentName || row.presidentCell ? `
            <div class="popup-row">
              <strong>President:</strong>
              ${escapeHtml(row.presidentName || '')}
              ${row.presidentCell ? `
                — <a class="phone" href="${escapeHtml(presPhoneHref)}">${escapeHtml(row.presidentCell)}</a>
              ` : ``}
            </div>
          ` : ``}

          ${row.vicePresidentName || row.vicePresidentCell ? `
            <div class="popup-row">
              <strong>Vice President:</strong>
              ${escapeHtml(row.vicePresidentName || '')}
              ${row.vicePresidentCell ? `
                — <a class="phone" href="${escapeHtml(vpPhoneHref)}">${escapeHtml(row.vicePresidentCell)}</a>
              ` : ``}
            </div>
          ` : ``}
        </div>
      `;
    }

    function addMarkers(rows) {
      cluster.clearLayers();

      const bounds = [];
      let mappedCount = 0;

      for (const row of rows) {
        if (typeof row.lat !== 'number' || typeof row.lng !== 'number') continue;

        mappedCount++;

        const label = locationLabel(row);
        const marker = L.marker([row.lat, row.lng]);

        // TWO-LINE hover tooltip (chapter + location)
        const tooltipHtml = `
          <strong>${escapeHtml(row.chapterName || 'Chapter')}</strong><br>
          ${escapeHtml(label)}
        `;
        marker.bindTooltip(tooltipHtml, {
          direction: 'top',
          sticky: true,
          opacity: 0.95
        });

        // Click popup
        marker.bindPopup(buildPopupHtml(row));

        cluster.addLayer(marker);
        bounds.push([row.lat, row.lng]);
      }

      metaEl.textContent = `Showing ${rows.length} chapters (${mappedCount} mapped)`;

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    function applySearch() {
      const q = searchEl.value.trim().toLowerCase();

      if (!q) {
        addMarkers(allData);
        return;
      }

      const filtered = allData.filter(r => {
        const hay = [
          r.chapterName,
          r.city,
          r.stateRegion,
          r.country,
          r.presidentName,
          r.presidentCell,
          r.vicePresidentName,
          r.vicePresidentCell
        ].filter(Boolean).join(' ').toLowerCase();

        return hay.includes(q);
      });

      addMarkers(filtered);
    }

    async function load() {
      const res = await fetch('chapters.json');
      if (!res.ok) throw new Error(`HTTP ${res.status} loading chapters.json`);

      const rows = await res.json();

      allData = rows.map(r => ({
        id: r.id,
        chapterName: r.chapterName,
        city: r.city,
        stateRegion: r.stateRegion,
        country: r.country,
        lat: r.lat,
        lng: r.lng,
        presidentName: r.presidentName,
        presidentCell: r.presidentCell,
        vicePresidentName: r.vicePresidentName,
        vicePresidentCell: r.vicePresidentCell
      }));

      addMarkers(allData);
    }

    searchEl.addEventListener('input', applySearch);

    load().catch(err => {
      metaEl.textContent = 'Failed to load chapters.json (check file placement)';
      console.error(err);
    });
  </script>
</body>
</html>
